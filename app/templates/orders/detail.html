{% extends 'base.html '%}

{% block content %}
<div class="container-fluid" style="padding-top: 28px; padding-bottom: 48px;">
    <span>
        <a href="/items" class="btn btn-primary float-end mx-2"><i class="fa-solid fa-cart-plus"></i> Add More Items to this Order</a>
        <a href="javascript:void(0);" class="btn btn-secondary float-end" onclick="history.back();"><i class="fa-solid fa-caret-left"></i> Back</a>
    </span>
    <h1>Order Detail</h1>
    <p class="text-muted">Order ID: <b>{{ order.id }}</b></p>
    <div class="accordion" id="accordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#sectionOrderDetail" aria-expanded="true" aria-controls="sectionOrderDetail">
                    Order Information
                </button>
            </h2>
            <div id="sectionOrderDetail" class="accordion-collapse collapse show m-3" aria-labelledby="sectionOrderDetail">
                <div id="accordion-body">
                    <form>
                        <h2>Order Information</h2>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="created_at">Created At</label>
                                <input type="text" class="form-control" id="created_at" name="created_at" readonly>
                            </div>
                            <div class="col">
                                <label for="created_by">Created By</label>
                                <input type="text" class="form-control" id="created_by" name="created_by" value="{{ order.created_by }}" readonly>
                            </div>
                            <div class="col">
                                <label for="updated_at">Last Modified At</label>
                                <input type="text" class="form-control" id="updated_at" name="updated_at" readonly>
                            </div>
                            <div class="col">
                                <label for="status">Status</label>
                                <input type="text" class="form-control" id="status" name="status" value="{{ order.get_status() }}" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="period">Period</label>
                                <input type="text" class="form-control" id="period" name="period" value="{{ order.period }}" readonly>
                            </div>
                            <div class="col">
                                <label for="division">Division</label>
                                <input type="text" class="form-control" id="division" name="division" value="{{ order.get_division() }}" readonly>
                            </div>
                            <div class="col">
                                <label for="fulfillment">
                                    Fulfillment 
                                    <span id="order_status" class="badge badge-pill"></span>
                                </label>
                                <input type="text" class="form-control" id="fulfillment" name="fulfillment" readonly>
                            </div>
                            <div class="col">
                                <label for="total">Total</label>
                                <input type="text" class="form-control" id="total" name="total" readonly>
                            </div>
                        </div>
                        <h2>Approvals</h2>
                        <div class="row">
                            <div class="col"><strong>By Division Leader</strong></div>
                            <div class="col"><strong>By Finance</strong></div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label for="division_approved_by">Approved By</label>
                                <input type="text" class="form-control" id="division_approved_by" name="division_approved_by" value="{{ order.approval_division_by }}" readonly>
                            </div>
                            <div class="col">
                                <label for="division_approved_date">Approved Date</label>
                                <input type="text" class="form-control" id="division_approved_at" name="division_approved_at" readonly>
                            </div>
                            <div class="col">
                                <label for="finance_approved_by">Approved By</label>
                                <input type="text" class="form-control" id="finance_approved_by" name="finance_approved_by" value="{{ order.approval_finance_by }}" readonly>
                            </div>
                            <div class="col">
                                <label for="finance_approved_date">Approved Date</label>
                                <input type="text" class="form-control" id="finance_approved_at" name="finance_approved_at" readonly>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#sectionOrderItems" aria-expanded="false" aria-controls="sectionOrderItems">
                    Order Items
                </button>
            </h2>
            <div id="sectionOrderItems" class="accordion-collapse collapse show" aria-labelledby="sectionOrderItems">
                <div class="accordion-body">
                    <table id="data" class="table table-striped" style="width: 100%;">
                        <thead style="vertical-align: middle;">
                            <tr>
                                <th data-priority="2">Item ID</th>
                                <th data-priority="1">Brand</th>
                                <th data-priority="1">Name</th>
                                <th data-priority="1">Variant</th>
                                <th data-priority="2">Quantity</th>
                                <th data-priority="2">Price</th>
                                <th data-priority="2">Subtotal</th>
                                <th data-priority="3">Remarks</th>
                                <th data-priority="2">Actions</th>
                                <th>Qty. Unit</th>
                                <th>Validated</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Update Quantity Modal -->
<div class="modal fade" id="updateQtyModal" tabindex="-1" aria-labelledby="updateQtyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateQtyModalLabel">Update Quantity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="updateQtyModalBody">
                <form>
                    <input type="hidden" id="qty_update_item_id" name="qty_update_item_id">
                    <div class="row mb-3">
                        <div class="col">
                            <label for="qty_update_item_name">Item Name</label>
                            <input type="text" class="form-control" id="qty_update_item_name" name="qty_update_item_name" readonly>
                        </div>
                        <div class="col">
                            <label for="qty_update_price">Price</label>
                            <input type="text" class="form-control" id="qty_update_price" name="qty_update_price" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="qty_update_qty">Quantity</label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button" id="btnMinus10Qty"><i class="fas fa-minus"></i> 10</button>
                                <button class="btn btn-outline-secondary" type="button" id="btnMinusQty"><i class="fas fa-minus"></i></button>
                                <input type="number" class="form-control text-end" id="qty_update_qty" name="qty_update_qty" min="0" max="100" required>
                                <span class="input-group-text" id="qty_update_qty_unit"></span>
                                <button class="btn btn-outline-secondary" type="button" id="btnPlusQty"><i class="fas fa-plus"></i></button>
                                <button class="btn btn-outline-secondary" type="button" id="btnPlus10Qty"><i class="fas fa-plus"></i> 10</button>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col">
                            <p class="float-end text-end">
                                <span class="text-muted">Subtotal</span><br>
                                <span class="fs-5 fw-bold" id="qty_update_subtotal"></span>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Close</button>
                <button type="button" class="btn btn-primary" id="btnUpdateQty"><i class="fas fa-save"></i> Update Quantity</button>
            </div>
        </div>
    </div>
</div>
<!-- Order Item Details Modal -->
<div class="modal fade" id="orderItemDetailsModal" tabindex="-1" aria-labelledby="orderItemDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemDetailsModalLabel">Order Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="itemDetailsModalBody">
                <form>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="item_details_item_id">Item ID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="item_details_item_id" name="item_details_item_id" readonly>
                                <button class="btn btn-secondary" type="button" id="btnViewDetails"><i class="fas fa-info-circle"></i></button>
                            </div>
                        </div>
                        <div class="col">
                            <label for="item_details_item_name">Item Name</label>
                            <input type="text" class="form-control" id="item_details_item_name" name="item_details_item_name" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="item_details_price">Price</label>
                            <input type="text" class="form-control" id="item_details_price" name="item_details_price" readonly>
                        </div>
                        <div class="col">
                            <label for="item_details_quantity">Quantity</label>
                            <div class="input-group">
                                <input type="text" class="form-control text-end" id="item_details_quantity" name="item_details_quantity" readonly>
                                <span class="input-group-text" id="item_details_qty_unit"></span>
                                <button class="btn btn-primary" type="button" id="btnModalUpdateQty"><i class="fas fa-plus-minus"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="item_details_remarks">Remarks</label>
                            <textarea class="form-control" id="item_details_remarks" name="item_details_remarks" rows="3"></textarea>
                            <button type="button" class="btn btn-primary mt-2 float-end" id="btnModalUpdateRemarks" disabled><i class="fas fa-save"></i> Update Remarks</button>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col">
                            <p class="float-end text-end">
                                <span class="text-muted">Subtotal</span><br>
                                <span class="fs-5 fw-bold" id="item_details_subtotal"></span>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <div>
                    <button type="button" class="btn btn-outline-danger" id="btnModalRemoveItem"><i class="fas fa-trash-alt"></i> Remove Item</button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Item Details Modal -->
<div class="modal fade" id="modalItemDetails" tabindex="-1" aria-labelledby="modalItemDetailsLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalItemDetailsLabel"><i class="fas fa-info-circle"></i> Item Details</h5>
                <span class="badge bg-secondary mx-2" id="item_validated"></span>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col">
                        <label for="item_id" class="form-label"><i class="fas fa-qrcode"></i> Item ID (SKU)</label>
                        <input type="text" class="form-control" id="item_id" readonly>
                    </div>
                    <div class="col">
                        <label for="item_category" class="form-label">Category</label>
                        <input type="text" class="form-control" id="item_category" readonly>
                    </div>
                </div>
                <a class="text-muted my-3" data-bs-toggle="collapse" href="#item_metadata" role="button" aria-expanded="false" aria-controls="item_metadata">
                    <small>Show/Hide Metadata</small>
                </a>
                <div class="collapse my-3" id="item_metadata">
                    <div class="row mb-3">
                        <div class="col">
                            <label for="item_created_at" class="form-label">Created At</label>
                            <input type="text" class="form-control" id="item_created_at" readonly>
                        </div>
                        <div class="col">
                            <label for="item_created_by" class="form-label">Created By</label>
                            <input type="text" class="form-control" id="item_created_by" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="item_modification_at" class="form-label">Last Modified At</label>
                            <input type="text" class="form-control" id="item_modification_at" readonly>
                        </div>
                        <div class="col">
                            <label for="item_modified_by" class="form-label">Last Modified By</label>
                            <input type="text" class="form-control" id="item_modified_by" readonly>
                        </div>
                    </div>
                </div>
                <hr class="my-4">
                <div class="row mb-3">
                    <div class="col">
                        <label for="item_brand" class="form-label">Brand</label>
                        <input type="text" class="form-control" id="item_brand" readonly>
                    </div>
                    <div class="col">
                        <label for="item_name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="item_name" readonly>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label for="item_variant" class="form-label">Variant</label>
                        <input type="text" class="form-control" id="item_variant" readonly>
                    </div>
                    <div class="col">
                        <label for="item_description" class="form-label">Description</label>
                        <textarea class="form-control" id="item_description" rows="3" readonly></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label for="item_base_price" class="form-label">Base Price</label>
                        <input type="text" class="form-control" id="item_base_price" readonly>
                    </div>
                    <div class="col">
                        <label for="item_qty_unit" class="form-label">Quantity Unit</label>
                        <input type="text" class="form-control" id="item_qty_unit" readonly>
                    </div>
                </div>                
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const btnMinusQty = document.getElementById('btnMinusQty');
    const btnPlusQty = document.getElementById('btnPlusQty');
    const btnMinus10Qty = document.getElementById('btnMinus10Qty');
    const btnPlus10Qty = document.getElementById('btnPlus10Qty');
    const btnUpdateQty = document.getElementById('btnUpdateQty');

    const btnModalUpdateQty = document.getElementById('btnModalUpdateQty');
    const btnModalRemoveItem = document.getElementById('btnModalRemoveItem');
    const btnModalUpdateRemarks = document.getElementById('btnModalUpdateRemarks');
    const btnViewDetails = document.getElementById('btnViewDetails');

    async function getOrderTotal()
    {
        try
        {
            const response = await fetch(`/api/order/{{ order.id }}/total`, { method: 'GET' });
            const data = await response.json();

            if (response.ok)
                $('#total').val(formatCurrency(data.total));
            else
                displayToast('Order Total Error', response.statusText, 'error');
        }
        catch (error)
        {
            displayToast('Failed to Retrieve Order Total', error, 'error');
        }
    }

    // Remove Item Function
    async function removeItem(item_id)
    {
        const response = await fetch(`/api/order/{{ order.id }}/item/${item_id}`, 
        {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok)
        {
            displayToast('Remove Item', 'Item removed successfully.');
            updateCartItemsCount();
            updateCartTopItems();
            $('#data').DataTable().ajax.reload();
        }
        else
        {
            if (data.error != null)
                err_title = data.error;
            else
                err_title = 'Remove Item Error';

            if (data.details != null)
                displayPopupAlert(err_title, data.details, 'error');
            else if (data.available_fields != null)
                displayPopupAlert(err_title, `Available fields: ${data.available_fields}`, 'error');
            else
                displayPopupAlert(err_title, response.statusText, 'error');
        }
    }

    $(document).ready(function() 
    {
        $('#data').DataTable(
        {
            ajax: 
            {
                url: "/api/order/{{ order.id }}/items",
                dataSrc: "",
                type: "GET"
            },
            columns: 
            [
                { 
                    data: "item_id", // 0
                    render: function(data, type, row, meta) 
                    {
                        if (type === 'display') 
                        {
                            if (row.validated == 1)
                                return `<span class="text-success"><i class="fa-solid fa-check-double"></i></span> ${data}`;
                            else
                                return `<span class="text-danger"><i class="fa-solid fa-xmark"></i></span> ${data}`;
                        }

                        return data;
                    }
                },
                { data: "brand" }, // 1
                { data: "name" }, // 2
                { data: "variant" }, // 3
                { 
                    data: "quantity", // 4
                    render: function(data, type, row, meta) 
                    {
                        if (type === 'display')
                            return `${data} ${row.qty_unit}`;

                        return data;
                    }
                },
                { 
                    data: "price", // 5
                    render: function(data, type, row, meta) 
                        {
                            if (type === 'display')
                                return formatCurrency(data);

                            return data;
                        }
                },
                { 
                    data: "sub_total", // 6
                    render: function(data, type, row, meta) 
                    {
                        if (type === 'display')
                            return formatCurrency(data);

                        return data;
                    }
                },
                { data: "remarks" }, // 7
                {
                    data: null, // 8
                    render: function(data, type, row, meta) 
                    {
                        var buttons = `<button class="btn btn-primary btn-sm" id="btnUpdateQty_${row.item_id}"><i class="fas fa-plus-minus"></i></button>
                        <button class="btn btn-secondary btn-sm" id="btnViewDetails_${row.item_id}"><i class="fas fa-info-circle"></i></button>
                        <button class="btn btn-danger btn-sm" id="btnRemoveItem_${row.item_id}"><i class="fas fa-trash-alt"></i></button>`;
                        
                        return buttons;
                    }
                },
                { data: "qty_unit" }, // 9
                { 
                    data: "validated", // 10
                    render: function(data, type, row, meta) 
                    {
                        if (type === 'display') 
                        {
                            if (data == 1)
                                return "Validated Item";
                            else
                                return "Non-validated Item";
                        }

                        return data;
                    }
                }
            ],
            columnDefs: 
            [
                { visible: false, targets: [5, 9, 10] },
                { width: '20%', targets: [0] },
                { width: '25%', targets: [7] },
                { width: '10%', targets: [8] }
            ],
            order: [[0, 'asc']],
            fixedHeader: true,
            responsive: true,
            language: 
            {
                searchBuilder: 
                {
                    button: 
                    {
                        0: 'Advanced Search',
                        _: 'Advanced Search (%d)'
                    },
                    title:
                    {
                        _: 'Advanced Search (%d)',
                        0: 'Advanced Search'
                    },
                    data: 'Item'
                }
            },
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            layout: 
            {
                top2Start: 'info',
                top2End: 
                {
                    buttons: 
                    [
                        {
                            extend: 'colvis',
                            text: 'Columns',
                            columns: [0, 1, 2, 3, 4, 5, 6, 7],
                        },
                        {
                            extend: 'collection',
                            text: 'Exportâ€¦',
                            buttons:
                            [
                                {
                                    extend: 'excelHtml5',
                                    text: 'Excel',
                                    autoFilter: true,
                                    filename: `Toku_Items_List_${new Date().toISOString().slice(0, 10)}`,
                                    messageBottom: `Exported on ${new Date().toISOString().slice(0, 10)}. Generated by JACITA Toku.`,
                                    sheetName: 'Network Clients',
                                    exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6, 7] }
                                },
                                {
                                    extend: 'pdfHtml5',
                                    text: 'PDF',
                                    filename: `Toku_Items_List_${new Date().toISOString().slice(0, 10)}`,
                                    download: 'open',
                                    messageBottom: `Exported on ${new Date().toISOString().slice(0, 10)}. Generated by JACITA Toku.`,
                                    pageSize: 'A4',
                                    orientation: 'landscape',
                                    exportOptions: { columns: [0, 1, 2, 3, 4, 5, 6, 7] }
                                }
                            ]
                        },
                        {
                            text: 'Refresh',
                            attr:  { id: 'btnRefresh' },
                            action: function (e, dt, node, config) 
                            {
                                const btnRefresh = document.getElementById('btnRefresh');
                                btnRefresh.disabled = true;
                                btnRefresh.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';

                                displayToast('Data Refresh', 'Refreshing data from the server...', 'info');
                                dt.searchPanes.clearSelections();
                                
                                dt.ajax.reload(function() 
                                {
                                    setTimeout(() => dt.searchPanes.rebuildPane(), 2000);

                                    btnRefresh.disabled = false;
                                    btnRefresh.innerHTML = 'Refresh';

                                    displayToast('Data Refresh', 'Data refreshed successfully.');
                                });
                            }
                        }              
                    ]
                },
                bottomStart: null,
                bottomEnd: 'paging',
            }
        });

        // Format Dates
        const DATE_OPTIONS = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        $('#created_at').val(new Date('{{ order.created_date }}').toLocaleString("en-GB", DATE_OPTIONS));
        $('#updated_at').val(new Date('{{ order.last_modification_date }}').toLocaleString("en-GB", DATE_OPTIONS));
        $('#division_approved_at').val(new Date('{{ order.approval_division_date }}').toLocaleString("en-GB", DATE_OPTIONS));
        $('#finance_approved_at').val(new Date('{{ order.approval_finance_date }}').toLocaleString("en-GB", DATE_OPTIONS));

        // Fulfillment Status
        if ('{{ order.fulfillment_date }}' == '' || '{{ order.fulfillment_date }}' == 'None')
        {
            $('#fulfillment').val('Not yet fulfilled');
            $('#fulfillment').addClass('text-warning');
            $('#order_status').html('<i class="fa-solid fa-clock"></i>');
            $('#order_status').addClass('bg-secondary');
        }
        else
        {
            $('#fulfillment').val(`Fulfilled on ${new Date('{{ order.fulfillment_date }}').toLocaleString("en-GB", DATE_OPTIONS)}`);
            $('#fulfillment').addClass('text-success');
            $('#order_status').html('<i class="fa-solid fa-check-double"></i>');
            $('#order_status').addClass('bg-success');
        }

        getOrderTotal();
    });

    // Update Quantity Button
    $('#data').on('click', 'button[id^="btnUpdateQty_"]', function() 
    {
        if (this.id.startsWith('btnUpdateQty_') == false)
            return;

        const id = this.id.split('_')[1];
        const item = $('#data').DataTable().row((idx, data) => data.item_id == id).data();

        $('#qty_update_item_id').val(item.item_id);
        $('#qty_update_item_name').val(`${item.brand} ${item.name} ${item.variant}`);
        $('#qty_update_price').val(formatCurrency(item.price));
        $('#qty_update_qty').val(item.quantity);
        $('#qty_update_qty_unit').text(item.qty_unit);
        $('#qty_update_subtotal').text(formatCurrency(item.sub_total));

        $('#updateQtyModal').modal('show');
    });

    // View Details Button
    $('#data').on('click', 'button[id^="btnViewDetails_"]', function() 
    {
        if (this.id.startsWith('btnViewDetails_') == false)
            return;

        const id = this.id.split('_')[1];
        const item = $('#data').DataTable().row((idx, data) => data.item_id == id).data();

        $('#item_details_item_id').val(item.item_id);
        $('#item_details_item_name').val(`${item.brand} ${item.name} ${item.variant}`);
        $('#item_details_price').val(formatCurrency(item.price));
        $('#item_details_quantity').val(`${item.quantity}`);
        $('#item_details_qty_unit').text(item.qty_unit);
        $('#item_details_remarks').val(item.remarks);
        $('#item_details_subtotal').text(formatCurrency(item.sub_total));

        $('#orderItemDetailsModal').modal('show');
    });

    // Remove Item Button
    $('#data').on('click', 'button[id^="btnRemoveItem_"]', function() 
    {
        if (this.id.startsWith('btnRemoveItem_') == false)
            return;

        const id = this.id.split('_')[1];
        const item = $('#data').DataTable().row((idx, data) => data.item_id == id).data();

        displayPopupConfirm('Remove Item', `Are you sure you want to remove ${item.brand} ${item.name} ${item.variant} from the order? This action cannot be undone.`,
        confirmCallback = async () => 
        {
            displayToast('Removing Item', 'Please wait while we remove the item...', 'info');
            removeItem(item.item_id);
        },
        denyCallback = () => {},
        confirmText = 'Yes, remove this item',
        denyText = 'No, keep this item');
    });

    // View Item Details Button (Modal)
    btnViewDetails.addEventListener('click', async () =>
    {
        const id = $('#item_details_item_id').val();
        const response = await fetch(`/api/item/${id}?human_readable=true`, { method: 'GET' });
        const data = await response.json();

        // Preformat Date
        const DATE_OPTIONS = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        data.created_date = new Date(data.created_date).toLocaleString("en-GB", DATE_OPTIONS);
        data.modification_date = new Date(data.modification_date).toLocaleString("en-GB", DATE_OPTIONS);

        // Item Validation
        if (data.validated == false)
        {
            $('#item_validated').html(`<i class="fa-solid fa-xmark"></i> Non-validated`);
            $('#item_validated').removeClass('bg-success');
            $('#item_validated').addClass('bg-danger');
        }
        else
        {
            $('#item_validated').html(`<i class="fa-solid fa-check-double"></i> Validated`);
            $('#item_validated').removeClass('bg-danger');
            $('#item_validated').addClass('bg-success');
        }

        // Item Metadata
        $('#item_id').val(data.id);
        $('#item_category').val(data.category);
        $('#item_created_at').val(data.created_date);
        $('#item_created_by').val(data.created_by);
        $('#item_modification_at').val(data.modification_date);
        $('#item_modified_by').val(data.modification_by);

        // Item Information
        $('#item_brand').val(data.brand);
        $('#item_name').val(data.name);
        $('#item_variant').val(data.variant);
        $('#item_base_price').val(formatCurrency(data.base_price));
        $('#item_qty_unit').val(data.qty_unit);

        if (data.description == null || data.description == '')
        {
            $('#item_description').val('No description provided.');
            $('#item_description').addClass('text-muted');
            $('#item_description').attr('rows', 1);
        }
        else
        {
            $('#item_description').val(data.description);
            $('#item_description').removeClass('text-muted');
            $('#item_description').attr('rows', 3);
        }

        $('#modalItemDetails').modal('show');
    });

    // Update Quantity Button (Modal)
    btnModalUpdateQty.addEventListener('click', function() 
    {
        const item_id = $('#item_details_item_id').val();
        const qty = parseInt($('#item_details_quantity').val());

        $('#qty_update_item_id').val(item_id);
        $('#qty_update_item_name').val($('#item_details_item_name').val());
        $('#qty_update_price').val($('#item_details_price').val());
        $('#qty_update_qty').val(qty);
        $('#qty_update_qty_unit').text($('#item_details_qty_unit').text());
        $('#qty_update_subtotal').text($('#item_details_subtotal').text());

        $('#orderItemDetailsModal').modal('hide');
        $('#updateQtyModal').modal('show');
    });

    // Remarks Change Event (Modal)
    $('#item_details_remarks').on('change', function() 
    {
        btnModalUpdateRemarks.disabled = false;
    });

    // Update Remarks Button (Modal)
    btnModalUpdateRemarks.addEventListener('click', async function() 
    {
        const item_id = $('#item_details_item_id').val();
        const remarks = $('#item_details_remarks').val();

        const formData = new FormData();
        formData.append('remarks', remarks);

        const response = await fetch(`/api/order/{{ order.id }}/item/${item_id}`, 
        {
            method: 'PATCH',
            body: formData
        });

        const data = await response.json();

        $('#orderItemDetailsModal').modal('hide');

        if (response.ok)
        {
            displayToast('Update Remarks', 'Remarks updated successfully.');
            $('#data').DataTable().ajax.reload();
        }
        else
        {
            if (data.error != null)
                err_title = data.error;
            else
                err_title = 'Update Remarks Error';

            if (data.details != null)
                displayPopupAlert(err_title, data.details, 'error');
            else if (data.available_fields != null)
                displayPopupAlert(err_title, `Available fields: ${data.available_fields}`, 'error');
            else
                displayPopupAlert(err_title, response.statusText, 'error');
        }
    });

    // Remove Item Button (Modal)
    btnModalRemoveItem.addEventListener('click', async function() 
    {
        const item_name = $('#item_details_item_name').val();
        await displayPopupConfirm('Remove Item', `Are you sure you want to remove ${item_name} from the order? This action cannot be undone.`,
        confirmCallback = async () => 
        {
            $('#orderItemDetailsModal').modal('hide');
            displayToast('Removing Item', 'Please wait while we remove the item...', 'info');
            const item_id = $('#item_details_item_id').val();
            removeItem(item_id);
        },
        denyCallback = () => {},
        confirmText = 'Yes, remove this item',
        denyText = 'No, keep this item');
    });

    // Details Modal Close Event
    $('#orderItemDetailsModal').on('hidden.bs.modal', function() 
    {
        $('#item_details_remarks').val('');
        $('#item_details_subtotal').text('');
        btnModalUpdateRemarks.disabled = true;
    });

    // Finalize Update Quantity Button
    btnUpdateQty.addEventListener('click', async function() 
    {
        const item_id = $('#qty_update_item_id').val();
        const qty = parseInt($('#qty_update_qty').val());

        if (qty < 1 || qty > 100)
            return displayPopupAlert('Quantity Error', 'Quantity must be between 1 and 100.', 'error');

        const formData = new FormData();
        formData.append('quantity', qty);

        const response = await fetch(`/api/order/{{ order.id }}/item/${item_id}`, 
        {
            method: 'PATCH',
            body: formData
        });

        const data = await response.json();

        $('#updateQtyModal').modal('hide');

        if (response.ok)
        {
            displayToast('Update Quantity', 'Quantity updated successfully.');
            updateCartItemsCount();
            updateCartTopItems();
            $('#data').DataTable().ajax.reload();
        }
        else
        {
            if (data.error != null)
                err_title = data.error;
            else
                err_title = 'Update Quantity Error';

            if (data.details != null)
                displayPopupAlert(err_title, data.details, 'error');
            else if (data.available_fields != null)
                displayPopupAlert(err_title, `Available fields: ${data.available_fields}`, 'error');
            else
                displayPopupAlert(err_title, response.statusText, 'error');
        }
    });

    // Quantity Change Event
    $('#qty_update_qty').on('change', function() 
    {
        const qty = parseInt($(this).val());
        const price = parseFloat($('#qty_update_price').val().replace(/[^0-9.-]+/g, ''));
        const subtotal = qty * price;

        $('#qty_update_subtotal').text(formatCurrency(subtotal));
    });

    // Quantity Manipulation
    btnMinusQty.addEventListener('click', function() 
    {
        const qtyInput = $('#qty_update_qty');
        let qty = parseInt(qtyInput.val());

        if (qty == 1)
            return displayPopupAlert('Quantity Error', 'Quantity cannot be less than 1.', 'error');

        qtyInput.val(qty - 1).trigger('change');
    });

    btnPlusQty.addEventListener('click', function() 
    {
        const qtyInput = $('#qty_update_qty');
        let qty = parseInt(qtyInput.val());

        if (qty == 100)
            displayPopupAlert('Quantity Error', 'Quantity cannot be more than 100.', 'error');
            
        qtyInput.val(qty + 1).trigger('change');
    });

    btnMinus10Qty.addEventListener('click', function() 
    {
        const qtyInput = $('#qty_update_qty');
        let qty = parseInt(qtyInput.val());

        if (qty == 1)
            return displayPopupAlert('Quantity Error', 'Quantity cannot be less than 1.', 'error');

        qty = Math.max(qty - 10, 1);
        qtyInput.val(qty).trigger('change');
    });

    btnPlus10Qty.addEventListener('click', function() 
    {
        const qtyInput = $('#qty_update_qty');
        let qty = parseInt(qtyInput.val());
    
        if (qty >= 100)
            return displayPopupAlert('Quantity Error', 'Quantity cannot be more than 100.', 'error');
    
        qty = Math.min(qty + 10, 100);
        qtyInput.val(qty).trigger('change');
    });
</script>
{% endblock %}